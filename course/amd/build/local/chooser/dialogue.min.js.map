{"version":3,"sources":["../../../src/local/chooser/dialogue.js"],"names":["carouselPageTo","carousel","moduleData","Templates","renderForPromise","html","js","help","find","selectors","regions","replaceNodeContents","on","helpContent","querySelector","chooserSummary","description","focus","registerListenerEvents","modal","mappedModules","getBody","interval","pause","keyboard","addEventListener","e","target","closest","actions","optionActions","showSummary","module","chooserOption","container","moduleName","dataset","modname","get","matches","closeOption","allModules","modules","caller","getModuleSelector","initKeyboardNavigation","chooserOptions","querySelectorAll","Array","from","forEach","element","document","keyCode","enter","space","arrowRight","arrowDown","currentOption","nextOption","nextElementSibling","firstOption","firstElementChild","clickErrorHandler","arrowLeft","arrowUp","previousOption","previousElementSibling","lastOption","lastElementChild","home","end","tab","closeBtn","getModal","hide","item","fallback","displayChooser","origin","sectionModules","Map","set","modulename","getRoot","ModalEvents","hidden","destroy","show"],"mappings":"0QAwBA,OACA,OACA,OACA,O,mrBAUMA,CAAAA,CAAc,4CAAG,WAAMC,CAAN,CAAgBC,CAAhB,8GAEMC,CAAAA,CAAS,CAACC,gBAAV,CAA2B,0BAA3B,CAAuDF,CAAvD,CAFN,iBAEZG,CAFY,GAEZA,IAFY,CAENC,CAFM,GAENA,EAFM,CAGbC,CAHa,CAGNN,CAAQ,CAACO,IAAT,CAAcC,UAAUC,OAAV,CAAkBH,IAAhC,EAAsC,CAAtC,CAHM,gBAKbJ,CAAAA,CAAS,CAACQ,mBAAV,CAA8BJ,CAA9B,CAAoCF,CAApC,CAA0CC,CAA1C,CALa,QAQnBL,CAAQ,CAACA,QAAT,CAAkB,MAAlB,EACAA,CAAQ,CAACW,EAAT,CAAY,kBAAZ,CAAgC,UAAM,CAClC,GAAMC,CAAAA,CAAW,CAAGN,CAAI,CAACO,aAAL,CAAmBL,UAAUC,OAAV,CAAkBK,cAAlB,CAAiCC,WAApD,CAApB,CACAH,CAAW,CAACI,KAAZ,EACH,CAHD,EATmB,yCAAH,uD,CAsBdC,CAAsB,CAAG,SAACC,CAAD,CAAQC,CAAR,CAA0B,CACrD,GAAMnB,CAAAA,CAAQ,CAAG,cAAEkB,CAAK,CAACE,OAAN,GAAgB,CAAhB,EAAmBP,aAAnB,CAAiCL,UAAUC,OAAV,CAAkBT,QAAnD,CAAF,CAAjB,CACAA,CAAQ,CAACA,QAAT,CAAkB,CACdqB,QAAQ,GADM,CAEdC,KAAK,GAFS,CAGdC,QAAQ,GAHM,CAAlB,EAMAL,CAAK,CAACE,OAAN,GAAgB,CAAhB,EAAmBI,gBAAnB,CAAoC,OAApC,4CAA6C,WAAMC,CAAN,iGACrCA,CAAC,CAACC,MAAF,CAASC,OAAT,CAAiBnB,UAAUoB,OAAV,CAAkBC,aAAlB,CAAgCC,WAAjD,CADqC,iBAE/BC,CAF+B,CAEtBN,CAAC,CAACC,MAAF,CAASC,OAAT,CAAiBnB,UAAUC,OAAV,CAAkBuB,aAAlB,CAAgCC,SAAjD,CAFsB,CAG/BC,CAH+B,CAGlBH,CAAM,CAACI,OAAP,CAAeC,OAHG,CAI/BnC,CAJ+B,CAIlBkB,CAAa,CAACkB,GAAd,CAAkBH,CAAlB,CAJkB,gBAK/BnC,CAAAA,CAAc,CAACC,CAAD,CAAWC,CAAX,CALiB,QASzC,GAAIwB,CAAC,CAACC,MAAF,CAASY,OAAT,CAAiB9B,UAAUoB,OAAV,CAAkBW,WAAnC,CAAJ,CAAqD,CAEjDvC,CAAQ,CAACA,QAAT,CAAkB,MAAlB,EACAA,CAAQ,CAACW,EAAT,CAAY,kBAAZ,CAAgC,UAAM,IAC5B6B,CAAAA,CAAU,CAAGtB,CAAK,CAACE,OAAN,GAAgB,CAAhB,EAAmBP,aAAnB,CAAiCL,UAAUC,OAAV,CAAkBgC,OAAnD,CADe,CAE5BC,CAAM,CAAGF,CAAU,CAAC3B,aAAX,CAAyBL,UAAUC,OAAV,CAAkBkC,iBAAlB,CAAoClB,CAAC,CAACC,MAAF,CAASS,OAAT,CAAiBC,OAArD,CAAzB,CAFmB,CAGlCM,CAAM,CAAC1B,KAAP,EACH,CAJD,CAKH,CAjBwC,wCAA7C,yDAqBA4B,CAAsB,CAAC1B,CAAD,CAAQC,CAAR,CACzB,C,CASKyB,CAAsB,CAAG,SAAC1B,CAAD,CAAQC,CAAR,CAA0B,CAErD,GAAM0B,CAAAA,CAAc,CAAG3B,CAAK,CAACE,OAAN,GAAgB,CAAhB,EAAmB0B,gBAAnB,CAAoCtC,UAAUC,OAAV,CAAkBuB,aAAlB,CAAgCC,SAApE,CAAvB,CAEAc,KAAK,CAACC,IAAN,CAAWH,CAAX,EAA2BI,OAA3B,CAAmC,SAACC,CAAD,CAAa,CAC5C,MAAOA,CAAAA,CAAO,CAAC1B,gBAAR,CAAyB,OAAzB,4CAAkC,WAAMC,CAAN,mHAC/BoB,CAD+B,CACdM,QAAQ,CAACtC,aAAT,CAAuBL,UAAUC,OAAV,CAAkBoC,cAAzC,CADc,MAIjCpB,CAAC,CAAC2B,OAAF,GAAcC,OAAd,EAAuB5B,CAAC,CAAC2B,OAAF,GAAcE,OAJJ,uBAK7B7B,CAAC,CAACC,MAAF,CAASY,OAAT,CAAiB9B,UAAUoB,OAAV,CAAkBC,aAAlB,CAAgCC,WAAjD,CAL6B,kBAMvBC,CANuB,CAMdN,CAAC,CAACC,MAAF,CAASC,OAAT,CAAiBnB,UAAUC,OAAV,CAAkBuB,aAAlB,CAAgCC,SAAjD,CANc,CAOvBC,CAPuB,CAOVH,CAAM,CAACI,OAAP,CAAeC,OAPL,CAQvBnC,CARuB,CAQVkB,CAAa,CAACkB,GAAd,CAAkBH,CAAlB,CARU,CASvBlC,CATuB,CASZ,cAAEkB,CAAK,CAACE,OAAN,GAAgB,CAAhB,EAAmBP,aAAnB,CAAiCL,UAAUC,OAAV,CAAkBT,QAAnD,CAAF,CATY,CAU7BA,CAAQ,CAACA,QAAT,CAAkB,CACdqB,QAAQ,GADM,CAEdC,KAAK,GAFS,CAGdC,QAAQ,GAHM,CAAlB,EAV6B,gBAevBxB,CAAAA,CAAc,CAACC,CAAD,CAAWC,CAAX,CAfS,SAoBrC,GAAIwB,CAAC,CAAC2B,OAAF,GAAcG,YAAd,EAA4B9B,CAAC,CAAC2B,OAAF,GAAcI,WAA9C,CAAyD,CACrD,GAAI,CAAC/B,CAAC,CAACC,MAAF,CAASY,OAAT,CAAiB9B,UAAUoB,OAAV,CAAkBC,aAAlB,CAAgCC,WAAjD,CAAL,CAAoE,CAC1D2B,CAD0D,CAC1ChC,CAAC,CAACC,MAAF,CAASC,OAAT,CAAiBnB,UAAUC,OAAV,CAAkBuB,aAAlB,CAAgCC,SAAjD,CAD0C,CAE1DyB,CAF0D,CAE7CD,CAAa,CAACE,kBAF+B,CAG1DC,CAH0D,CAG5Cf,CAAc,CAACgB,iBAH6B,CAIhEC,CAAiB,CAACJ,CAAD,CAAaE,CAAb,CACpB,CACJ,CAGD,GAAInC,CAAC,CAAC2B,OAAF,GAAcW,WAAd,EAA2BtC,CAAC,CAAC2B,OAAF,GAAcY,SAA7C,CAAsD,CAClD,GAAI,CAACvC,CAAC,CAACC,MAAF,CAASY,OAAT,CAAiB9B,UAAUoB,OAAV,CAAkBC,aAAlB,CAAgCC,WAAjD,CAAL,CAAoE,CAC1D2B,CAD0D,CAC1ChC,CAAC,CAACC,MAAF,CAASC,OAAT,CAAiBnB,UAAUC,OAAV,CAAkBuB,aAAlB,CAAgCC,SAAjD,CAD0C,CAE1DgC,CAF0D,CAEzCR,CAAa,CAACS,sBAF2B,CAG1DC,CAH0D,CAG7CtB,CAAc,CAACuB,gBAH8B,CAIhEN,CAAiB,CAACG,CAAD,CAAiBE,CAAjB,CACpB,CACJ,CAED,GAAI1C,CAAC,CAAC2B,OAAF,GAAciB,MAAlB,CAAwB,CACdT,CADc,CACAf,CAAc,CAACgB,iBADf,CAEpBD,CAAW,CAAC5C,KAAZ,EACH,CAED,GAAIS,CAAC,CAAC2B,OAAF,GAAckB,KAAlB,CAAuB,CACbH,CADa,CACAtB,CAAc,CAACuB,gBADf,CAEnBD,CAAU,CAACnD,KAAX,EACH,CAED,GAAIS,CAAC,CAAC2B,OAAF,GAAcmB,KAAlB,CAAuB,CAEnB,GAAI9C,CAAC,CAACC,MAAF,CAASY,OAAT,CAAiB9B,UAAUC,OAAV,CAAkBuB,aAAlB,CAAgCC,SAAjD,GAA+DR,CAAC,CAACC,MAAF,GAAamB,CAAc,CAACgB,iBAA/F,CAAkH,CACxGW,CADwG,CAC7FtD,CAAK,CAACuD,QAAN,GAAiB,CAAjB,EAAoB5D,aAApB,CAAkCL,UAAUoB,OAAV,CAAkB8C,IAApD,CAD6F,CAE9GF,CAAQ,CAACxD,KAAT,EACH,CACJ,CAvDoC,yCAAlC,wDAyDV,CA1DD,CA2DH,C,CASK8C,CAAiB,CAAG,SAACa,CAAD,CAAOC,CAAP,CAAoB,CAC1C,GAAa,IAAT,GAAAD,CAAJ,CAAmB,CACfA,CAAI,CAAC3D,KAAL,EACH,CAFD,IAEO,CACH4D,CAAQ,CAAC5D,KAAT,EACH,CACJ,C,CAUY6D,CAAc,4CAAG,WAAMC,CAAN,CAAc5D,CAAd,CAAqB6D,CAArB,yFAGpB5D,CAHoB,CAGJ,GAAI6D,CAAAA,GAHA,CAI1BD,CAAc,CAAC9B,OAAf,CAAuB,SAAClB,CAAD,CAAY,CAC/BZ,CAAa,CAAC8D,GAAd,CAAkBlD,CAAM,CAACmD,UAAzB,CAAqCnD,CAArC,CACH,CAFD,EAJ0B,eASpBd,CAAAA,CAAsB,CAACC,CAAD,CAAQC,CAAR,CATF,QAY1BD,CAAK,CAACiE,OAAN,GAAgBxE,EAAhB,CAAmByE,CAAW,CAACC,MAA/B,CAAuC,UAAM,CACzCnE,CAAK,CAACoE,OAAN,EACH,CAFD,EAIApE,CAAK,CAACqE,IAAN,GAhB0B,wCAAH,uD","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * A type of dialogue used as for choosing options.\n *\n * @module     core_course/local/chooser/dialogue\n * @package    core\n * @copyright  2019 Mihail Geshoski <mihail@moodle.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport $ from 'jquery';\nimport * as ModalEvents from 'core/modal_events';\nimport selectors from 'core_course/local/chooser/selectors';\nimport * as Templates from 'core/templates';\nimport {end, arrowLeft, arrowRight, arrowUp, arrowDown, home, tab, enter, space} from 'core/key_codes';\n\n/**\n * Given an event from the main module 'page' navigate to it's help section via a carousel.\n *\n * @method carouselPageTo\n * @param {jQuery} carousel Our initialized carousel to manipulate\n * @param {Object} moduleData Data of the module to carousel to\n */\nconst carouselPageTo = async(carousel, moduleData) => {\n    // Build up the html & js ready to place into the help section.\n    const {html, js} = await Templates.renderForPromise('core_course/chooser_help', moduleData);\n    const help = carousel.find(selectors.regions.help)[0];\n\n    await Templates.replaceNodeContents(help, html, js);\n\n    // Trigger the transition between 'pages'.\n    carousel.carousel('next');\n    carousel.on('slid.bs.carousel', () => {\n        const helpContent = help.querySelector(selectors.regions.chooserSummary.description);\n        helpContent.focus();\n    });\n};\n\n/**\n * Register chooser related event listeners.\n *\n * @method registerListenerEvents\n * @param {Promise} modal Our modal that we are working with\n * @param {Map} mappedModules A map of all of the modules we are working with with K: mod_name V: {Object}\n */\nconst registerListenerEvents = (modal, mappedModules) => {\n    const carousel = $(modal.getBody()[0].querySelector(selectors.regions.carousel));\n    carousel.carousel({\n        interval: false,\n        pause: true,\n        keyboard: false\n    });\n\n    modal.getBody()[0].addEventListener('click', async(e) => {\n        if (e.target.closest(selectors.actions.optionActions.showSummary)) {\n            const module = e.target.closest(selectors.regions.chooserOption.container);\n            const moduleName = module.dataset.modname;\n            const moduleData = mappedModules.get(moduleName);\n            await carouselPageTo(carousel, moduleData);\n        }\n\n        // From the help screen go back to the module overview.\n        if (e.target.matches(selectors.actions.closeOption)) {\n            // Trigger the transition between 'pages'.\n            carousel.carousel('prev');\n            carousel.on('slid.bs.carousel', () => {\n                const allModules = modal.getBody()[0].querySelector(selectors.regions.modules);\n                const caller = allModules.querySelector(selectors.regions.getModuleSelector(e.target.dataset.modname));\n                caller.focus();\n            });\n        }\n    });\n\n    // Register event listeners related to the keyboard navigation controls.\n    initKeyboardNavigation(modal, mappedModules);\n};\n\n/**\n * Initialise the keyboard navigation controls for the chooser.\n *\n * @method initKeyboardNavigation\n * @param {Promise} modal Our modal that we are working with\n * @param {Map} mappedModules A map of all of the modules we are working with with K: mod_name V: {Object}\n */\nconst initKeyboardNavigation = (modal, mappedModules) => {\n\n    const chooserOptions = modal.getBody()[0].querySelectorAll(selectors.regions.chooserOption.container);\n\n    Array.from(chooserOptions).forEach((element) => {\n        return element.addEventListener('keyup', async(e) => {\n            const chooserOptions = document.querySelector(selectors.regions.chooserOptions);\n\n            // Check for enter/ space triggers for showing the help.\n            if (e.keyCode === enter || e.keyCode === space) {\n                if (e.target.matches(selectors.actions.optionActions.showSummary)) {\n                    const module = e.target.closest(selectors.regions.chooserOption.container);\n                    const moduleName = module.dataset.modname;\n                    const moduleData = mappedModules.get(moduleName);\n                    const carousel = $(modal.getBody()[0].querySelector(selectors.regions.carousel));\n                    carousel.carousel({\n                        interval: false,\n                        pause: true,\n                        keyboard: false\n                    });\n                    await carouselPageTo(carousel, moduleData);\n                }\n            }\n\n            // Next.\n            if (e.keyCode === arrowRight || e.keyCode === arrowDown) {\n                if (!e.target.matches(selectors.actions.optionActions.showSummary)) {\n                    const currentOption = e.target.closest(selectors.regions.chooserOption.container);\n                    const nextOption = currentOption.nextElementSibling;\n                    const firstOption = chooserOptions.firstElementChild;\n                    clickErrorHandler(nextOption, firstOption);\n                }\n            }\n\n            // Previous.\n            if (e.keyCode === arrowLeft || e.keyCode === arrowUp) {\n                if (!e.target.matches(selectors.actions.optionActions.showSummary)) {\n                    const currentOption = e.target.closest(selectors.regions.chooserOption.container);\n                    const previousOption = currentOption.previousElementSibling;\n                    const lastOption = chooserOptions.lastElementChild;\n                    clickErrorHandler(previousOption, lastOption);\n                }\n            }\n\n            if (e.keyCode === home) {\n                const firstOption = chooserOptions.firstElementChild;\n                firstOption.focus();\n            }\n\n            if (e.keyCode === end) {\n                const lastOption = chooserOptions.lastElementChild;\n                lastOption.focus();\n            }\n\n            if (e.keyCode === tab) {\n                // We want the user to get focus on the close button if they tab through an entire module.\n                if (e.target.matches(selectors.regions.chooserOption.container) && e.target !== chooserOptions.firstElementChild) {\n                    const closeBtn = modal.getModal()[0].querySelector(selectors.actions.hide);\n                    closeBtn.focus();\n                }\n            }\n        });\n    });\n};\n\n/**\n * Small error handling function to make sure the navigated to object exists\n *\n * @method clickErrorHandler\n * @param {HTMLElement} item What we want to check exists\n * @param {HTMLElement} fallback If we dont match anything fallback the focus\n */\nconst clickErrorHandler = (item, fallback) => {\n    if (item !== null) {\n        item.focus();\n    } else {\n        fallback.focus();\n    }\n};\n\n/**\n * Display the module chooser.\n *\n * @method displayChooser\n * @param {HTMLElement} origin The calling button\n * @param {Object} modal Our created modal for the section\n * @param {Array} sectionModules An array of all of the built module information\n */\nexport const displayChooser = async(origin, modal, sectionModules) => {\n\n    // Make a map so we can quickly fetch a specific module's object for either rendering or searching.\n    const mappedModules = new Map();\n    sectionModules.forEach((module) => {\n        mappedModules.set(module.modulename, module);\n    });\n\n    // Register event listeners.\n    await registerListenerEvents(modal, mappedModules);\n\n    // We want to focus on the action select when the dialog is closed.\n    modal.getRoot().on(ModalEvents.hidden, () => {\n        modal.destroy();\n    });\n\n    modal.show();\n};\n"],"file":"dialogue.min.js"}