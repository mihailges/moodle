{"version":3,"sources":["../src/insight_selection.js"],"names":["ACTIONS","SELECT_ALL","CLEAR_ALL","getDataSelector","name","value","getPredictionCheckboxSelector","toggleGroup","getInsightSelectionContainerSelector","getActionElementSelector","action","getSelectedPredictions","selectedPredictions","JSON","parse","LocalStorage","get","setSelectedPredictions","set","stringify","getAllPredictions","insightSelectionContainer","document","querySelector","dataset","allpredictions","registerListenerEvents","PubSub","subscribe","CheckboxToggleAll","events","checkboxToggled","data","toggleGroupName","handlePredictionToggle","addEventListener","e","target","matches","allPredictions","setGroupState","renderNotification","checkedSlaves","toArray","slaves","$","each","index","slave","predictionId","parseInt","val","isSelected","indexOf","wasSelected","length","push","splice","getTemplateData","notificationData","Templates","renderForPromise","html","js","replaceNodeContents","togglePredictionsOnLoad","predictionCheckboxElements","querySelectorAll","selectedPredictionsOnPage","forEach","predictionCheckboxElement","map","selectedPrediction","checked","actions","togglegroup","text","unshift","templateData","insightsselected","init"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n *\n * @module     report_insights/insight_selection\n * @package    report_insights\n * @copyright  2020 Mihail Geshoski <mihail@moodle.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport $ from 'jquery';\nimport * as PubSub from 'core/pubsub';\nimport CheckboxToggleAll from 'core/checkbox-toggleall';\nimport Templates from 'core/templates';\nimport {get_string as getString} from 'core/str';\nimport LocalStorage from 'core/localstorage';\n\nconst ACTIONS = {\n    SELECT_ALL: 'select-all',\n    CLEAR_ALL: 'clear-selection'\n};\n\nconst getDataSelector = (name, value) => {\n    return `[data-${name}=\"${value}\"]`;\n};\n\nconst getPredictionCheckboxSelector = (toggleGroup) => {\n    return `input[type=\"checkbox\"]${getDataSelector('toggle', 'slave')}${getDataSelector('togglegroup', toggleGroup)}`;\n};\n\nconst getInsightSelectionContainerSelector = (toggleGroup) => {\n    return `${getDataSelector('region', 'insight-selection')}${getDataSelector('togglegroup', toggleGroup)}`;\n};\n\nconst getActionElementSelector = (action, toggleGroup) => {\n    return `${getDataSelector('action', action)}${getDataSelector('togglegroup', toggleGroup)}`;\n};\n\nexport const getSelectedPredictions = () => {\n    const selectedPredictions = JSON.parse(LocalStorage.get('selectedPredictions'));\n    return selectedPredictions ? selectedPredictions : [];\n};\n\nexport const setSelectedPredictions = (selectedPredictions) => {\n    LocalStorage.set('selectedPredictions', JSON.stringify(selectedPredictions));\n};\n\nconst getAllPredictions = (toggleGroup) => {\n    const insightSelectionContainer = document.querySelector(getInsightSelectionContainerSelector(toggleGroup));\n    return JSON.parse(insightSelectionContainer.dataset.allpredictions);\n};\n\n/**\n * Register related event listeners.\n *\n * @method registerListenerEvents\n */\nconst registerListenerEvents = (toggleGroup) => {\n    PubSub.subscribe(CheckboxToggleAll.events.checkboxToggled, (data) => {\n        if (data.toggleGroupName === toggleGroup) {\n            handlePredictionToggle(data);\n        }\n    });\n\n    document.addEventListener('click', async (e) => {\n\n        // All existing insights are selected.\n        if (e.target.matches(getActionElementSelector(ACTIONS.SELECT_ALL, toggleGroup))) {\n            const allPredictions = getAllPredictions(toggleGroup);\n\n            setSelectedPredictions(allPredictions);\n            CheckboxToggleAll.setGroupState(document, toggleGroup, true);\n\n            renderNotification(allPredictions, toggleGroup);\n        }\n\n        // Insight selection is cleared.\n        if (e.target.matches(getActionElementSelector(ACTIONS.CLEAR_ALL, toggleGroup))) {\n            setSelectedPredictions([]);\n            CheckboxToggleAll.setGroupState(document, toggleGroup, false);\n\n            renderNotification([], toggleGroup);\n        }\n    });\n};\n\n/**\n * Method that handles the selection/deselection of predictions based on the 'checkboxToggled' event and\n * displays a notification depending on the number of selected insights.\n *\n * @method handlePredictionToggle\n * @param {Object} data The data returned by the 'checkboxToggled' event.\n */\nconst handlePredictionToggle = async (data) => {\n    const checkedSlaves = data.checkedSlaves.toArray();\n    const slaves = data.slaves.toArray();\n    let selectedPredictions = getSelectedPredictions();\n\n    $.each(slaves, (index, slave) => {\n        const predictionId = parseInt($(slave).val());\n        const isSelected = checkedSlaves.indexOf(slave) > -1;\n        const wasSelected = selectedPredictions.length > 0 &&\n            selectedPredictions.indexOf(predictionId) > -1;\n\n        if (isSelected && !wasSelected) {\n            selectedPredictions.push(predictionId);\n        } else if (!isSelected && wasSelected) {\n            selectedPredictions.splice(selectedPredictions.indexOf(predictionId), 1);\n        }\n    });\n\n    setSelectedPredictions(selectedPredictions);\n\n    renderNotification(selectedPredictions, data.toggleGroupName);\n};\n\n/**\n * Render notification.\n *\n * @method renderNotification\n * @param {Object} notificationData The object with the required data for the notification template.\n */\nconst renderNotification = async (selectedPredictions, toggleGroup) => {\n    const notificationData = await getTemplateData(selectedPredictions, toggleGroup);\n    const {html, js} = await Templates.renderForPromise('report_insights/insights_selected', notificationData);\n    await Templates.replaceNodeContents(getInsightSelectionContainerSelector(toggleGroup), html, js);\n};\n\n/**\n * Remove notification.\n *\n * @method clearNotification\n */\nconst clearNotification = (toggleGroup) => {\n    [...document.querySelectorAll(getInsightSelectionContainerSelector(toggleGroup))].map(container => container.innerHTML = '');\n};\n\nconst togglePredictionsOnLoad = (toggleGroup) => {\n    const selectedPredictions = getSelectedPredictions();\n    const predictionCheckboxElements = document.querySelectorAll(getPredictionCheckboxSelector(toggleGroup));\n    let selectedPredictionsOnPage = [];\n\n    predictionCheckboxElements.forEach(predictionCheckboxElement => {\n        const predictionId = parseInt(predictionCheckboxElement.value);\n        if (selectedPredictions.indexOf(predictionId) > -1) {\n            selectedPredictionsOnPage.push(predictionCheckboxElement);\n        }\n    });\n\n    if (predictionCheckboxElements.length === selectedPredictionsOnPage.length) {\n        CheckboxToggleAll.setGroupState(document, toggleGroup, true);\n    } else {\n        selectedPredictionsOnPage.map(selectedPrediction => selectedPrediction.checked = true);\n    }\n\n    renderNotification(selectedPredictions, toggleGroup);\n};\n\nconst getTemplateData = async (selectedPredictions, toggleGroup) => {\n    let actions = [];\n    const allPredictions = getAllPredictions(toggleGroup);\n\n    if (selectedPredictions.length > 0) {\n        actions.push({\n            action: ACTIONS.CLEAR_ALL,\n            togglegroup: toggleGroup,\n            text: await getString('clearselection', 'report_insights')\n        });\n\n        if (selectedPredictions.length !== allPredictions.length) {\n            actions.unshift({\n                action: ACTIONS.SELECT_ALL,\n                togglegroup: toggleGroup,\n                text: await getString('selectallinsights', 'report_insights', allPredictions.length)\n            });\n        }\n    } else {\n        actions.push({\n            action: ACTIONS.SELECT_ALL,\n            togglegroup: toggleGroup,\n            text: await getString('selectallinsights', 'report_insights', allPredictions.length)\n        });\n    }\n\n    const templateData = {\n        insightsselected: await getString('insightsselected', 'report_insights', selectedPredictions.length),\n        actions: actions\n    };\n\n    return templateData;\n};\n\n/**\n * Set up the actions.\n *\n * @method init\n */\nexport const init = (toggleGroup) => {\n    registerListenerEvents(toggleGroup);\n    togglePredictionsOnLoad(toggleGroup);\n};\n"],"file":"insight_selection.min.js"}