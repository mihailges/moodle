YUI.add("moodle-mod_quiz-toolboxes",function(r,e){var t,i,n,o="activityinstance",_="editinstructions",m="editor_displayed",s="select-multiple",a="editing_show",E="titleeditor",T={ACTIONAREA:".actions",ACTIONLINKTEXT:".actionlinktext",ACTIVITYACTION:"a.cm-edit-action[data-action], a.editing_maxmark, a.editing_section, input.shuffle_questions",ACTIVITYFORM:"span.instancemaxmarkcontainer form",ACTIVITYINSTANCE:"."+o,SECTIONINSTANCE:".sectioninstance",ACTIVITYLI:"li.activity, li.section",ACTIVITYMAXMARK:"input[name=maxmark]",COMMANDSPAN:".commands",CONTENTAFTERLINK:"div.contentafterlink",CONTENTWITHOUTLINK:"div.contentwithoutlink",DELETESECTIONICON:"a.editing_delete .icon",DESELECTALL:"#questiondeselectall",EDITMAXMARK:"a.editing_maxmark",EDITSECTION:"a.editing_section",EDITSECTIONICON:"a.editing_section .icon",EDITSHUFFLEQUESTIONSACTION:"input.cm-edit-action[data-action]",EDITSHUFFLEAREA:".instanceshufflequestions .shuffle-progress",HIDE:"a.editing_hide",HIGHLIGHT:"a.editing_highlight",INSTANCENAME:"span.instancename",INSTANCEMAXMARK:"span.instancemaxmark",INSTANCESECTION:"span.instancesection",INSTANCESECTIONAREA:"div.section-heading",MODINDENTDIV:".mod-indent",MODINDENTOUTER:".mod-indent-outer",NUMQUESTIONS:".numberofquestions",PAGECONTENT:"div#page-content",PAGELI:"li.page",SECTIONLI:"li.section",SECTIONUL:"ul.section",SECTIONFORM:".instancesectioncontainer form",SECTIONINPUT:"input[name=section]",SELECTMULTIPLEBUTTON:"#selectmultiplecommand",SELECTMULTIPLECANCELBUTTON:"#selectmultiplecancelcommand",SELECTMULTIPLECHECKBOX:".select-multiple-checkbox",SELECTMULTIPLEDELETEBUTTON:"#selectmultipledeletecommand",SELECTALL:"#questionselectall",SHOW:"a."+a,SLOTLI:"li.slot",SUMMARKS:".mod_quiz_summarks"},c=r.one(document.body);M.mod_quiz=M.mod_quiz||{},t=function(){t.superclass.constructor.apply(this,arguments)},r.extend(t,r.Base,{send_request:function(e,n,o,t){var i,s,a,c,l;for(s in e=e||{},i=this.get("config").pageparams)e[s]=i[s];if(e.sesskey=M.cfg.sesskey,e.courseid=this.get("courseid"),e.quizid=this.get("quizid"),a=M.cfg.wwwroot+this.get("ajaxurl"),c=[],l={method:"POST",data:e,on:{success:function(e,t){try{(c=r.JSON.parse(t.responseText)).error&&new M.core.ajaxException(c)}catch(i){}c.hasOwnProperty("newsummarks")&&r.one(T.SUMMARKS).setHTML(c.newsummarks),c.hasOwnProperty("newnumquestions")&&r.one(T.NUMQUESTIONS).setHTML(M.util.get_string("numquestionsx","quiz",c.newnumquestions)),o&&r.bind(o,this,c)(),n&&window.setTimeout(function(){n.hide()},400)},failure:function(e,t){n&&n.hide(),new M.core.ajaxException(t)}},context:this},t)for(s in t)l[s]=t[s];return n&&n.show(),r.io(a,l),this}},{NAME:"mod_quiz-toolbox",ATTRS:{courseid:{value:0},quizid:{value:0},ajaxurl:{value:null},config:{value:{}}}}),i=function(){i.superclass.constructor.apply(this,arguments)},r.extend(i,t,{editmaxmarkevents:[],NODE_PAGE:1,NODE_SLOT:2,NODE_JOIN:3,initializer:function(){M.mod_quiz.quizbase.register_module(this),r.delegate("click",this.handle_data_action,c,T.ACTIVITYACTION,this),r.delegate("click",this.handle_data_action,c,T.DEPENDENCY_LINK,this),this.initialise_select_multiple()},initialise_select_multiple:function(){r.one(T.SELECTMULTIPLEBUTTON).on("click",function(e){e.preventDefault(),r.one("body").addClass(s)}),r.one(T.SELECTMULTIPLECANCELBUTTON).on("click",function(e){e.preventDefault(),r.one("body").removeClass(s)}),r.one(T.SELECTALL).on("click",function(e){e.preventDefault(),r.all(T.SELECTMULTIPLECHECKBOX).set("checked","checked")}),r.one(T.DESELECTALL).on("click",function(e){e.preventDefault(),r.all(T.SELECTMULTIPLECHECKBOX).set("checked","")}),r.one(T.SELECTMULTIPLEDELETEBUTTON).setAttribute("disabled","disabled"),r.delegate("click",this.delete_multiple_action,c,T.SELECTMULTIPLEDELETEBUTTON,this),r.delegate("click",this.toggle_select_all_buttons_enabled,c,T.SELECTMULTIPLECHECKBOX,this),r.delegate("click",this.toggle_select_all_buttons_enabled,c,T.SELECTALL,this),r.delegate("click",this.toggle_select_all_buttons_enabled,c,T.DESELECTALL,this)},handle_data_action:function(e){var t,i,n=e.target;if(n.test("a")||(n=n.ancestor(T.ACTIVITYACTION)),t=n.getData("action"),i=n.ancestor(T.ACTIVITYLI),n.test("a")&&t&&i)switch(t){case"editmaxmark":this.edit_maxmark(e,n,i,t);break;case"delete":this.delete_with_confirmation(e,n,i,t);break;case"addpagebreak":case"removepagebreak":this.update_page_break(e,n,i,t);break;case"adddependency":case"removedependency":this.update_dependency(e,n,i,t)}},add_spinner:function(e){var t=e.one(T.ACTIONAREA);return t?M.util.add_spinner(r,t):null},toggle_select_all_buttons_enabled:function(){var e=r.all(T.SELECTMULTIPLECHECKBOX+":checked"),t=r.one(T.SELECTMULTIPLEDELETEBUTTON);e&&!e.isEmpty()?t.removeAttribute("disabled"):t.setAttribute("disabled","disabled")},delete_with_confirmation:function(i,e,t){var n,o,s;i.preventDefault(),n=t,o="",s=M.util.get_string("pluginname","qtype_"+n.getAttribute("class").match(/qtype_([^\s]*)/)[1]),o=M.util.get_string("confirmremovequestion","quiz",s),new M.core.confirm({question:o,modal:!0}).on("complete-yes",function(){var e=this.add_spinner(n),t={"class":"resource",action:"DELETE",id:r.Moodle.mod_quiz.util.slot.getId(n)};this.send_request(t,e,function(e){e.deleted&&(r.Moodle.mod_quiz.util.slot.remove(n),this.reorganise_edit_page(),M.core.actionmenu&&M.core.actionmenu.instance&&M.core.actionmenu.instance.hideMenu(i))})},this)},find_sections_that_would_become_empty:function(){var o,e=r.all(T.SECTIONLI);return 1<e.size()&&e.some(function(e){var t=e.one(T.INSTANCESECTION).getContent(),i=e.all(T.SELECTMULTIPLECHECKBOX+":checked"),n=e.all(T.SELECTMULTIPLECHECKBOX+":not(:checked)");return!i.isEmpty()&&n.isEmpty()&&(o=t),o}),o},delete_multiple_action:function(e){var t=this.find_sections_that_would_become_empty();void 0!==t?new M.core.alert({title:M.util.get_string("cannotremoveslots","quiz"),message:M.util.get_string("cannotremoveallsectionslots","quiz",t)}).show():this.delete_multiple_with_confirmation(e)},delete_multiple_with_confirmation:function(e){var i,n,o
;e.preventDefault(),i="",n=[],r.all(T.SELECTMULTIPLECHECKBOX+":checked").each(function(e){var t=r.Moodle.mod_quiz.util.slot.getSlotFromComponent(e);i+=""===i?"":",",i+=r.Moodle.mod_quiz.util.slot.getId(t),n.push(t)}),o=r.one("div.mod-quiz-edit-content"),n&&n.length&&new M.core.confirm({question:M.util.get_string("areyousureremoveselected","quiz"),modal:!0}).on("complete-yes",function(){var e=this.add_spinner(o),t={"class":"resource",field:"deletemultiple",ids:i};this.send_request(t,e,function(e){e.deleted&&(r.all(T.SELECTMULTIPLECHECKBOX+":checked").each(function(e){r.Moodle.mod_quiz.util.slot.remove(e.ancestor("li.activity"))}),this.reorganise_edit_page(),r.one("body").removeClass(s))})},this)},edit_maxmark:function(o,e,s){var a,t=s.one(T.INSTANCEMAXMARK),c=s.one(T.ACTIVITYINSTANCE),l=t.get("firstChild").get("data"),d=l,u=t,i={"class":"resource",field:"getmaxmark",id:r.Moodle.mod_quiz.util.slot.getId(s)};o.preventDefault(),this.send_request(i,null,function(e){var t,i,n;M.core.actionmenu&&M.core.actionmenu.instance&&M.core.actionmenu.instance.hideMenu(o),e.instancemaxmark&&(d=e.instancemaxmark),t=r.Node.create('<form action="#" />'),i=r.Node.create('<span class="'+_+'" id="id_editinstructions" />').set("innerHTML",M.util.get_string("edittitleinstructions","moodle")),n=r.Node.create('<input name="maxmark" type="text" class="'+E+'" />').setAttrs({value:d,autocomplete:"off","aria-describedby":"id_editinstructions",maxLength:"12",size:parseInt(this.get("config").questiondecimalpoints,10)+2}),t.appendChild(n),t.setData("anchor",u),c.insert(i,"before"),u.replace(t),s.addClass(m),n.focus().select(),a=n.on("blur",this.edit_maxmark_cancel,this,s,!1),this.editmaxmarkevents.push(a),a=n.on("key",this.edit_maxmark_cancel,"esc",this,s,!0),this.editmaxmarkevents.push(a),a=t.on("submit",this.edit_maxmark_submit,this,s,l),this.editmaxmarkevents.push(a)})},edit_maxmark_submit:function(e,t,i){var n,o,s;e.preventDefault(),n=r.Lang.trim(t.one(T.ACTIVITYFORM+" "+T.ACTIVITYMAXMARK).get("value")),o=this.add_spinner(t),this.edit_maxmark_clear(t),t.one(T.INSTANCEMAXMARK).setContent(n),null!==n&&""!==n&&n!==i&&(s={"class":"resource",field:"updatemaxmark",maxmark:n,id:r.Moodle.mod_quiz.util.slot.getId(t)},this.send_request(s,o,function(e){e.instancemaxmark&&t.one(T.INSTANCEMAXMARK).setContent(e.instancemaxmark)}))},edit_maxmark_cancel:function(e,t,i){i&&e.preventDefault(),this.edit_maxmark_clear(t)},edit_maxmark_clear:function(e){new r.EventHandle(this.editmaxmarkevents).detach();var t=e.one(T.ACTIVITYFORM),i=e.one("#id_editinstructions");t&&t.replace(t.getData("anchor")),i&&i.remove(),e.removeClass(m),r.later(100,this,function(){e.one(T.EDITMAXMARK).focus()}),r.one("input[name=maxmark")||r.one("body").append('<input type="text" name="maxmark" style="display: none">')},update_page_break:function(e,t,i,n){var o,s,a,c;return e.preventDefault(),o=i.next("li.activity.slot"),s=this.add_spinner(o),a="removepagebreak"===n?1:2,c={"class":"resource",field:"updatepagebreak",id:r.Moodle.mod_quiz.util.slot.getId(o),value:a},this.send_request(c,s,function(e){if(e.slots){if("addpagebreak"===n)r.Moodle.mod_quiz.util.page.add(i);else{var t=i.next(r.Moodle.mod_quiz.util.page.SELECTORS.PAGE);r.Moodle.mod_quiz.util.page.remove(t,!0)}this.reorganise_edit_page()}}),this},update_dependency:function(e,t,i,n){var o,s;return e.preventDefault(),o=this.add_spinner(i),s={"class":"resource",field:"updatedependency",id:r.Moodle.mod_quiz.util.slot.getId(i),value:"adddependency"===n?1:0},this.send_request(s,o,function(e){e.hasOwnProperty("requireprevious")&&r.Moodle.mod_quiz.util.slot.updateDependencyIcon(i,e.requireprevious)}),this},reorganise_edit_page:function(){r.Moodle.mod_quiz.util.slot.reorderSlots(),r.Moodle.mod_quiz.util.slot.reorderPageBreaks(),r.Moodle.mod_quiz.util.page.reorderPages(),r.Moodle.mod_quiz.util.slot.updateOneSlotSections(),r.Moodle.mod_quiz.util.slot.updateAllDependencyIcons()},NAME:"mod_quiz-resource-toolbox",ATTRS:{courseid:{value:0},quizid:{value:0}}}),M.mod_quiz.resource_toolbox=null,M.mod_quiz.init_resource_toolbox=function(e){return M.mod_quiz.resource_toolbox=new i(e),M.mod_quiz.resource_toolbox},n=function(){n.superclass.constructor.apply(this,arguments)},r.extend(n,t,{editsectionevents:[],initializer:function(){M.mod_quiz.quizbase.register_module(this),c.delegate("key",this.handle_data_action,"down:enter",T.ACTIVITYACTION,this),r.delegate("click",this.handle_data_action,c,T.ACTIVITYACTION,this),r.delegate("change",this.handle_data_action,c,T.EDITSHUFFLEQUESTIONSACTION,this)},handle_data_action:function(e){var t,i,n=e.target;if(n.test("a")||n.test("input[data-action]")||(n=n.ancestor(T.ACTIVITYACTION)),t=n.getData("action"),i=n.ancestor(T.ACTIVITYLI),(n.test("a")||n.test("input[data-action]"))&&t&&i)switch(t){case"edit_section_title":this.edit_section_title(e,n,i,t);break;case"shuffle_questions":this.edit_shuffle_questions(e,n,i,t);break;case"deletesection":this.delete_section_with_confirmation(e,n,i,t)}},delete_section_with_confirmation:function(e,t,i){e.preventDefault(),new M.core.confirm({question:M.util.get_string("confirmremovesectionheading","quiz",i.get("aria-label")),modal:!0}).on("complete-yes",function(){var e=M.util.add_spinner(r,i.one(T.ACTIONAREA)),t={"class":"section",action:"DELETE",id:i.get("id").replace("section-","")};this.send_request(t,e,function(e){e.deleted&&window.location.reload(!0)})},this)},edit_section_title:function(e,t,s){var a,i=s.get("id").replace("section-",""),c=s.one(T.INSTANCESECTION),l=c,n={"class":"section",field:"getsectiontitle",id:i};e.preventDefault(),this.send_request(n,null,function(e){var t=e.instancesection,i=r.Node.create('<form action="#" />'),n=r.Node.create('<span class="'+_+'" id="id_editinstructions" />').set("innerHTML",M.util.get_string("edittitleinstructions","moodle")),o=r.Node.create('<input name="section" type="text" />').setAttrs({value:t,autocomplete:"off","aria-describedby":"id_editinstructions",maxLength:"255"});i.appendChild(o),i.setData("anchor",l),
c.insert(n,"before"),l.replace(i),o.focus().select(),a=o.on("blur",this.edit_section_title_cancel,this,s,!1),this.editsectionevents.push(a),a=o.on("key",this.edit_section_title_cancel,"esc",this,s,!0),this.editsectionevents.push(a),a=i.on("submit",this.edit_section_title_submit,this,s,t),this.editsectionevents.push(a)})},edit_section_title_submit:function(e,i,t){var n,o,s;e.preventDefault(),n=r.Lang.trim(i.one(T.SECTIONFORM+" "+T.SECTIONINPUT).get("value")),o=M.util.add_spinner(r,i.one(T.INSTANCESECTIONAREA)),this.edit_section_title_clear(i),null!==n&&n!==t&&(i.one(T.INSTANCESECTION).setContent(n),s={"class":"section",field:"updatesectiontitle",newheading:n,id:i.get("id").replace("section-","")},this.send_request(s,o,function(e){if(e){i.one(T.INSTANCESECTION).setContent(e.instancesection),i.one(T.EDITSECTIONICON).set("title",M.util.get_string("sectionheadingedit","quiz",e.instancesection)),i.one(T.EDITSECTIONICON).set("alt",M.util.get_string("sectionheadingedit","quiz",e.instancesection));var t=i.one(T.DELETESECTIONICON);t&&(t.set("title",M.util.get_string("sectionheadingremove","quiz",e.instancesection)),t.set("alt",M.util.get_string("sectionheadingremove","quiz",e.instancesection)))}}))},edit_section_title_cancel:function(e,t,i){i&&e.preventDefault(),this.edit_section_title_clear(t)},edit_section_title_clear:function(e){new r.EventHandle(this.editsectionevents).detach();var t=e.one(T.SECTIONFORM),i=e.one("#id_editinstructions");t&&t.replace(t.getData("anchor")),i&&i.remove(),r.later(100,this,function(){e.one(T.EDITSECTION).focus()}),r.one("input[name=section]")||r.one("body").append('<input type="text" name="section" style="display: none">')},edit_shuffle_questions:function(e,t,i){var n,o,s;n=i.one(T.EDITSHUFFLEQUESTIONSACTION).get("checked")?1:0,o={"class":"section",field:"updateshufflequestions",id:i.get("id").replace("section-",""),newshuffle:n},e.preventDefault(),s=M.util.add_spinner(r,i.one(T.EDITSHUFFLEAREA)),this.send_request(o,s)}},{NAME:"mod_quiz-section-toolbox",ATTRS:{courseid:{value:0},quizid:{value:0}}}),M.mod_quiz.init_section_toolbox=function(e){return new n(e)}},"@VERSION@",{requires:["base","node","event","event-key","io","moodle-mod_quiz-quizbase","moodle-mod_quiz-util-slot","moodle-core-notification-ajaxexception"]});